---
toc: true
toc_sticky: true
categories:
- Computer Networking
title: "컴퓨터 네트워킹, [CHAPTER 04] 데이터 평면"
---

## 4.1 네트워크 계층 개요

### 4.1.1 포워딩과 라우팅: 데이터 평면과 제어 평면
- 포워딩
    1. 패킷이 라우터의 입력 링크에 도달했을 때 라우터가 그 패킷을 적절한 출력 링크로 이동시키는 것
    2. 데이터 평면의 기능

- 라우팅
    1. 송신자가 수신자에게 패킷을 전송할 때 네트워크 계층에서 패킷의 경로를 설정하는 것
    2. 제어평면의 기능

- 전통적인 제어 평면 vs SDN
    1. 전통적인 제어 평면에서는 데이터 평면과 제어 평면의 기능이 라우터 내에 모두 존재
    2. SDN에서는 제어 평면이 데이터 평면과 물리적으로 분리

### 4.1.2 네트워크 서비스 모델
- 네트워크 계층 제공 서비스
    1. 보장된 전달<br>
        패킷이 소스 호스트에서부터 목적지 호스트까지 도착하는 것을 보장
    2. 지연 제한 이내의 보장된 전달<br>
        호스트간의 특정 지연 제한 안에 전달을 보장
    3. 순서화 패킷 전달<br>
        패킷이 목적지에 송신된 순서로 도착하는 것을 보장
    4. 최소 대역폭 보장<br>
        송신, 수신 호스트 사이에 특정한 비트 속도의 전송 링크를 에뮬레이트하여 대역폭을 보장
    5. 보안 서비스<br>
        데이터그램들을 소스 호스트에서 암호화, 목적지 호스트에서 해독할 수 있게 하여 전송 계층의 모든 세그먼트들에 대해 기밀성을 제공

- 최선형 서비스
    1. 망측에서는 IP 계층이 데이타그램의 전송을 위하여 최대의 노력을 하지만, 확실한 전송의 보장을 하지는 않음
    2. 데이타의 흐름이 많거나 적거나 간에 시간지연이 없도록 하는 등의 신뢰성을 보증하지 않음
    3. 양단간 사용자에게 네트워크측에서 보장은 못하지만, 최선의 서비스 제공을 하려는 서비스 모델

## 4.2 라우터 내부에는 무엇이 있을까?

![01](/assets/img/Computer%20Networking/22-06-24-chapter-04/01.png)<br>
- 입력 포트<br>
    입력포트는 여러 기능을 수행한다. 위 그림을 보면 입력 포트의 맨 왼쪽 초록색 상자와 출력 포트의 맨 오른쪽 상자는 라우터로 들어오는 입력링크로 물리계층기능을 수행한다. 또한 입력 포트는 들어오는 링크의 반대편에 있는 링크 계층과 상호 운용하기 위해 필요한 링크 계층 기능을 수행한다. 이는 입력 포트와 출력포트에서 파란색 상자에 해당한다. 마지막으로 가장 중요한 빨간색 상자는 입력 포트에서 검색 기능을 수행한다.<br> 

- 스위칭 구조<br>
    스위칭 구조는 라우터의 입력 포트와 출력 포트를 연결하며 이는 라우터 내부에 포함되어 있다. 입력포트에서 포워딩 테이블을 참조하여 출력 포트가 결정되면 스위칭 구조에서는 이를 실질적으로 입력-출력 포트를 연결해주는 물리적인 연결을 의미한다. 

- 출력 포트<br>
    출력 포트는 스위칭 구조에서 수신한 패킷을 저장하고 필요한 링크 계층 및 물리적 계층 기능을 수행하여 출력 링크로 패킷을 전송한다. 링크가양방향 전송인 경우, 출력 포트는 일반적으로 동일한 링크의 입력 포트와 한 쌍을 이룬다. 만약 출력포트로 들어오는 패킷의 속도가 출력포트에서 처리되어 밖으로 나가는 훨씬 빠르게 되면 출력 포트의 버퍼는 대기하는 패킷이 점차 많아질 것이고 결국 버퍼가 꽉차게 되어 큐잉지연이 발생한다. 여기서 패킷 손실이나 지연이 발생할 수 있다.<br>

- 라우팅 프로세서<br>
    라우팅 프로세서는 control plane 영역 기능을 수행한다. 기존의 라우터에서는 라우팅 프로토콜을 실행하고 라우팅 테이블과 연결된 링크 상태 정보를 유지 관리하며 라우터의 포둬딩 테이블을 계산한다<br>

### 4.2.1 입력 포트 처리 및 목적지 기반 전달
- 목적지 주소에 기반을 둔 포워딩
    1. 일반적을 사용되고 있는 방식이다.
    2. 포워딩을 위해 포워딩 테이블을 가진 호스트나 라우터가 필요하다.
    3. 호스트가 전송할 패킷이 있거나, 라우터가 포워딩할 패킷을 수신할 경우, 포워딩 테이블을
    4. 참조하여 패킷을 전달할 다음 홉을 찾는다.
    5. Classless Addressing의 경우, prefix가 짧은 순서 (suffix가 긴 순서, 더 큰 네트워크)로
    6. 포워딩 테이블이 생성된다. 그 이유는 더 큰 네트워크에 포함되어 있다면, 뒤에 건 볼 필요도 없기 때문이다. 테이블을 다 뒤져봤는데 매핑되는 게 없으면 default로 설정되어 있는 홉으로 이동한다.

- 최장 프리픽스 매칭 규칙<br>
    목적지 ip주소의 "가장 긴 접두사"를 찾아 각 링크 인터페이스에 보내는 방법<br>
    ![05](/assets/img/Computer%20Networking/22-06-24-chapter-04/05.PNG)<br>
    만약 이 테이블을 갖는 라우터에 "11001000 00010111 00010110 10100001" 이 왔다면, 이 주소는 0번째 인터페이스로 향하는 주소와 *를 제외하고 모두 매칭 되기 때문에 0번으로 향한다. 반면, "11001000 00010111 00011000 10101010" 이 왔다면 1,2번 인터페이스와 모두 일치한다. 하지만 1번과 "더 길게 매칭되기 때문에" 가장 긴 접두사인 1번으로 향할 것이다.<br>

### 4.2.2 변환기<br>
![02](/assets/img/Computer%20Networking/22-06-24-chapter-04/02.PNG)<br>
1. 메모리로 구성되는 스위칭 구조가 있다. 이는 가장 단순하고 라우팅 프로세서를 직접 제어해서 입력포트와 출력 포트 사이에서 패킷을 스위칭하는전통적인 컴퓨터이다.
2.  버스를 통한 교환이다. 여기서는 입력포트는 라우팅 프로세서의 개입 없이 공유 버스를 통한 직접 출력 포트로 패킷을 전송한다.
3. 크로스바 교환방식이다. 앞서 말한 메모리와 버스를 통한 교환에서는 하나의 패킷이 스위칭 구조에서 출력되기위해 진행중인 상태면 다른 패킷은기다려야 한다. 하지만 크로스바 교환방식에서는 여러개의 패킷이 동시에 출력포트로 전달 될 수 있다.<br>

### 4.2.3 출력 포트 프로세싱<br>
![03](/assets/img/Computer%20Networking/22-06-24-chapter-04/03.png)<br>
- 위 그림의 출력 포트 프로세싱은 출력 포트의 메모리에 저장된 패킷을 가져와서 출력 링크를 통해 전송한다.<br>

### 4.2.4 어디에서 큐잉이 일어날까?<br>
![06](/assets/img/Computer%20Networking/22-06-24-chapter-04/06.png)<br>
 
- 입력 큐잉
    1. 스위칭 구조의 패킷 전달 속도가 입력 포트에서 보내주는 패킷 전달 속도보다 느릴 때 발생한다. 쉽게 말해서 입력포트에서 패킷을 다음 출력 포트로 전달해주기 위해 스위칭 구조에게 처리를 맡겼는데, 스위칭 구조에서 밀려오는 패킷을 빠르게 전달하지 못할 때 발생하는 것
    2. HOL(Head-Of-the-Line) 차단 현상<br>
        회선의 앞쪽에서 다른 패킷이 막고 있으므로 입력 큐에서 대기 중인 패킷은 사용할 출력 포트가 사용 중이지 않아도 스위칭 구조를 통해 전송되기 위해서 기다려야 하는 것

- 출력 큐잉<br>
    1. 출력 포트는 시간 단위(패킷 전송 시간)에 단일 패킷만을 전송할 수 있으므로, N개의 도착 패킷은 출력 링크를 통한 전송 큐에서 대기해야만 한다. 그러면 대기 중인 N개의 패킷 중에서 하나를 전송하는 순간 다시 N개의 패킷이 도착해버리는 상황이 된다. 따라서, 스위칭 구조가 포트 회선 속도의 N배가 빨라도 패킷 큐잉이 출력 포트에서 발생할 수 있다.
    2.  AQM(Active Queue Management) 알고리즘<br>
        들어오는 패킷을 저장할 메모리가 충분하지 않다면 도착한 패킷을 폐기하거나 이미 대기하고 있던 패킷을 폐기해서 공간을 확보해야한다. 이러한 패킷 폐기 정책을 위한 알고리즘

### 4.2.5 패킷 스케쥴링

- FIFO(First In First Out) 스케줄링<br>
FIFO 스케줄링은 간단하게 큐에 도착한 순서대로 전송하는 기법을 뜻한다. 이 때 만약 큐가 가득찼을 때 패킷을 버린다면 어떤 패킷을 버려야 할까? 이것도 다음과 같이 여러가지 방법이 있다.<br>
1. tail drop : 방금 도착한 패킷을 버린다.
2. priority : 우선순위에 기반해 패킷을 버린다.
3. random : 랜덤으로 패킷을 버린다.

- Priority 스케줄링<br>
가장 높은 우선순위의 패킷을 먼저 전송하는 기법을 뜻한다.

- Round Robin(RR) 스케줄링<br>
![07](/assets/img/Computer%20Networking/22-06-24-chapter-04/07.png)<br>
Round Robin 스케줄링은 패킷에 class를 부여하여 구분한다. 큐를 스캔하여 보낼 패킷이 있다면 각각의 클래스 별로 번갈아 패킷을 전송한다. 예를 들어 위와 같이 주황색 class 와 파란색 class가 있다고 하자.<br>
1. 가장 먼저 도착한 1번 패킷을 전송하기 위해 큐에 넣는다. 
2. 1번 패킷이 전송되길 기다리는 도중 2번 패킷과 3번 패킷이 도착했다.
3. 이 때 3번 패킷이 색이 다르므로 먼저 큐에 넣고 2번 패킷을 다음으로 넣는다.
4. 1번, 3번, 2번 패킷이 전송된다.
5. 4번 패킷이 도착했으므로 4번 패킷을 큐에 넣고 전송한다.
6. 5번 패킷이 도착했으므로 5번 패킷을 큐에 넣고 전송한다.

- Weighted Fair Queuing(WFQ)<br>
![08](/assets/img/Computer%20Networking/22-06-24-chapter-04/08.png)<br>
WFQ는 Round Robin을 일반화 한 방식이다. 각 클래스 마다 큐를 설정하여, 각각 클라스를 번갈아 패킷을 보내는 방식은 Round Robin과 비슷하다. 다만 다른점은 큐에 가중치(weight)를 둔다는 점이다.<br>

## 4.3 인터넷 프로토콜(IP): IPv4, 주소 지정, IPv6 등

### 4.3.1 IPv4 데이터그램 형식<br>
![09](/assets/img/Computer%20Networking/22-06-24-chapter-04/09.png)<br>
1. 버전 번호<br>
4비트로 데이터그램의 IP 프로토콜 버전을 명시한다. 다른 버전의 IP는 다른 데이터그램 형식을 사용하기 때문에 라우터는 버전 번호를 확인하여 데이터그램의 나머지 부분을 어떻게 해석하는지 결정한다.<br>
2. 헤더 길이<br>
IPv4 데이터그램은 헤더에 가변 길이의 옵션을 포함하기 때문에 4비트의 헤더 길이를 통해 IP 데이터그램에서 실제 페이로드가 시작하는 곳을 명시해준다. 대부분 IPv4 데이터그램은 옵션을 포함하지 않아서 데이터그램의 헤더는 20바이트가 통상적이다.<br>
3. 서비스 타입<br>
서비스 타입 비트는 서로 다른 유형의 IP 데이터그램을 구별한다. 예를 들어, 실시간 데이터그램(IP 통신 어플리케이션)과 비실시간 트래픽(FTP)을 구분할 수 있다. <br>
4. 데이터그램 길이<br>
바이트로 계산한 IP 데이터그램(헤더와 데이터)의 전체 길이이다. 이 필드의 크기는 16비트이므로 IP 데이터그램의 이론상 최대 길이는 65,536(2^16)바이트이지만 1,500바이트보다 큰 경우는 거의 없으므로 최대 크기의 이더넷 프레임의 페이로드 필드에 IP 데이터그램이 장착될 수 있다.<br>
5. 식별자, 플래그, 단편화 오프셋<br>
세 필드는 IP 단편화와 관계가 있다.<br>
6. TTL(Time-To-Live)<br>
이 필드는 네트워크에서 데이터그램이 무한히 순환하지 않도록 한다. 라우터가 데이터그램을 처리할 때마다 값을 감소시켜서 TTL 필드값이 0이 되면 라우터는 데이터그램을 폐기한다.<br>
7. 상위 계층 프로토콜<br>
이 필드는 일반적으로 IP 데이터그램이 최종 목적지에 도달했을 때만 사용한다. 이 필드값은 IP 데이터그램에서 데이터 부분이 전달될 목적지의 전송 계층의 특정 프로토콜을 명시한다. 예를 들어, 이 필드값이 "6"이면 데이터 부분을 TCP로, "17"이면 UDP로 데이터를 전달하라는 뜻이 된다.<br>
8. 헤더 체크섬<br>
헤더 체크섬은 라우터가 수신한 IP 데이터그램의 비트 오류를 탐지하는 데 도움을 준다.<br>
9. 출발지와 목적지 IP 주소<br>
출발지가 데이터그램을 생성할 때, 자신의 IP 주소를 출발지 IP 주소 필드에 삽입하고 목적지 IP 주소를 목적지 IP 주소 필드에 삽입한다.<br>
10. 옵션<br>
옵션 필드는 IP 헤더를 확장한다.<br>
11. 데이터(페이로드)<br>
데이터그램이 존재하는 이유이자 가장 중요한 마지막 필드이다. 대부분의 경우에 IP 데이터그램의 데이터 필드는 목적지에 전달하기 위해 전송 계층 세그먼트(TCP, UDP)를 포함하지만, ICMP 메시지와 같은 다른 유형의 데이터를 담기도 한다.<br>

### 4.3.2 IPv4 데이터그램 단편화
![10](/assets/img/Computer%20Networking/22-06-24-chapter-04/10.png)<br>
- 데이터그램의 크기가 크면 MTU(Maximum Transmission Unit)의 크기에 맞게 그 데이터를 나누는 것을 단편화라고 한다. Ethernet MTU는 1500바이트이고 보통 MT가 정의되어 있지 않다면 576바이트의 기본 크기로 보낸다.
- 바이트구조를 보면, 1비트는 R이며 나중을 위해 사용을 보류한 비트이고, 다음 1비트는 DF로
나타내며, 이 값이 1을 나타내면 이 데이터그램은 단편화를 해서는 안된다는 뜻이다. 다음 비트는 MF로 나타내며, 이 값이 1을 나타내면 이 데이터그램 뒤에 단편화된 데이터그램이
더 있다는 뜻이다. 오프셋은 해당 단편화 조각이 원래 데이터에서 몇 번째 데이터인지를 표시해주는 값이다. 오프셋은 8단위로 이루어져 있기 때문에 단편화를 하는 데이터는 8의 배수의 크기로 단편화 되어야 한다. 
- 단편화는 발신지, 경유지에서도 발생할 수 있으며 최종 목적지에서 재조립 된다. 단편화의 단점은 단편 손실 시 데이터그램 전체를 재전송해야 한다. IP계층은 데이터그램의 어떤 단편이 처음 도착하면 타이머(일반적으로 30~60초)를 시작하고 시간이 지나면 단편은 폐기된다.

### 4.3.3 IPv4 주소체계
